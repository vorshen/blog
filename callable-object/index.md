# callable-object
ä»Šå¤©æˆ‘ä»¬æ¥èŠä¸€èŠå¯è°ƒç”¨å¯¹è±¡ï¼Œä»åº•å±‚æ¥è¯´ï¼Œè°ƒç”¨æ˜¯æŒ‡æ–°å»ºäº†æ ˆå¸§ï¼Œå¯„å­˜å™¨æŒ‡å‘å‘ç”Ÿäº†å˜åŒ–ã€‚  
ä»ç›´è§‚ä¸Šçœ‹å¯ä»¥åŠ ()æ‰§è¡Œçš„å°±æ˜¯å¯è°ƒç”¨å¯¹è±¡ï¼æ¯”å¦‚æˆ‘ä»¬ç†Ÿæ‚‰çš„ javascript ä¸­å‡½æ•°ã€‚  

## javascript ä¸­çš„ callable
```
function drink() {
    console.log('åˆ©åˆ©ä¸æµæ³ªï¼Œå–é…’å–åˆ°é†‰');
}

drink();
```
ä½†æ˜¯æœ‰æ²¡æœ‰æƒ³è¿‡ï¼Œä¸ºä»€ä¹ˆè¿™æ®µä»£ç å¯ä»¥æŒ‰é¡ºåºæ‰§è¡Œï¼Ÿå¦‚æœäº†è§£ C æˆ–è€… Javaï¼Œç¨‹åºçš„å…¥å£ä¸€å®šæ˜¯ä¸€ä¸ª main å‡½æ•°ï¼Œä¸ºä»€ä¹ˆ js ä¸­æ— éœ€ main å‡½æ•°äº†å‘¢ï¼Ÿ

ä» v8 æºç ä¸€æ¢ç©¶ç«Ÿï¼Œè¿™æ˜¯å› ä¸º v8 ä¼šå°†æ•´ä¸ª js ä»£ç ï¼ŒåŒ…è£…æˆä¸€ä¸ªå‡½æ•°ï¼Œæºç ä½ç½®å¦‚ä¸‹ï¼š
```
// v8/src/execution/execution.cc

// ...
// â—code éå¸¸é‡è¦
Handle<Code> code =
      JSEntry(isolate, params.execution_target, params.is_construct);
  {
    // ...

    if (params.execution_target == Execution::Target::kCallable) {
      // clang-format off
      // {new_target}, {target}, {receiver}, return value: tagged pointers
      // {argv}: pointer to array of tagged pointers
      using JSEntryFunction = GeneratedCode<Address(
          Address root_register_value, Address new_target, Address target,
          Address receiver, intptr_t argc, Address** argv)>;
      // clang-format on
      JSEntryFunction stub_entry =
          JSEntryFunction::FromAddress(isolate, code->InstructionStart());

      Address orig_func = params.new_target->ptr();
      Address func = params.target->ptr();
      Address recv = params.receiver->ptr();
      Address** argv = reinterpret_cast<Address**>(params.argv);
      RuntimeCallTimerScope timer(isolate, RuntimeCallCounterId::kJS_Execution);
      // â—ä¸‹é¢æ˜¯çœŸæ­£çš„æ‰§è¡Œ
      value = Object(stub_entry.Call(isolate->isolate_data()->isolate_root(),
                                     orig_func, func, recv, params.argc, argv));
    // ...
```
Code å¯¹è±¡éå¸¸çš„é‡è¦ï¼Œè¿™ä¸ªå°±æ˜¯ v8 ä¸­å‡½æ•°æ‰§è¡Œçš„å…³é”®ï¼Œv8 ç›¸å…³åŸè¯æœ‰:  
> Code describes objects with on-the-fly generated machine code.  
>
> JSFunctions are pairs (context, function code), sometimes also called closures.  
JSFunction(v8 å†…æ•°æ®ç±»å‹) ç›¸æ¯”è¾ƒ JSObject é‡å¤§çš„å·®å¼‚ä¹Ÿå°±æ˜¯å¤šäº† code å±æ€§ï¼Œè¿™ä¹Ÿå°±æ˜¯ Function å¯ä»¥æ‰§è¡Œï¼Œè€Œ Object æ— æ³•æ‰§è¡Œçš„åŸå› ã€‚  

å…¶å®æˆ‘ä»¬å°†ä¸Šé¢åˆ—å­ä¸­çš„ js ä»£ç ï¼Œç¼–è¯‘æˆå­—èŠ‚ç ï¼Œä¹Ÿå¯ä»¥çœ‹å‡ºæ¥æ•´ä¸ªæ–‡æœ¬å¯ä»¥æ‰§è¡Œçš„åŸå› ã€‚  
```
[generated bytecode for function:  (0x06c008212561 <SharedFunctionInfo>)] // æ³¨æ„ç‚¹1
Parameter count 1
Register count 3
Frame size 24
         0x6c008212626 @    0 : 12 00             LdaConstant [0]
         0x6c008212628 @    2 : 26 f9             Star r1
         0x6c00821262a @    4 : 27 fe f8          Mov <closure>, r2
         0x6c00821262d @    7 : 62 3f 01 f9 02    CallRuntime [DeclareGlobals], r1-r2
         0x6c008212632 @   12 : 13 01 00          LdaGlobal [1], [0]
         0x6c008212635 @   15 : 26 f9             Star r1
         0x6c008212637 @   17 : 5d f9 02          CallUndefinedReceiver0 r1, [2] // æ³¨æ„ç‚¹3
         0x6c00821263a @   20 : 26 fa             Star r0
         0x6c00821263c @   22 : ab                Return 
Constant pool (size = 2)
Handler Table (size = 0)
Source Position Table (size = 0)

[generated bytecode for function: drink (0x06c0082125b9 <SharedFunctionInfo drink>)] // æ³¨æ„ç‚¹2
Parameter count 1
Register count 3
Frame size 24
         0x6c00821278a @    0 : 13 00 00          LdaGlobal [0], [0]
         0x6c00821278d @    3 : 26 f9             Star r1
         0x6c00821278f @    5 : 28 f9 01 02       LdaNamedProperty r1, [1], [2]
         0x6c008212793 @    9 : 26 fa             Star r0
         0x6c008212795 @   11 : 12 02             LdaConstant [2]
         0x6c008212797 @   13 : 26 f8             Star r2
         0x6c008212799 @   15 : 5a fa f9 f8 04    CallProperty1 r0, r1, r2, [4]
         0x6c00821279e @   20 : 0d                LdaUndefined 
         0x6c00821279f @   21 : ab                Return 
Constant pool (size = 3)
Handler Table (size = 0)
Source Position Table (size = 0)
```
æ²¡æ¥è§¦è¿‡å­—èŠ‚ç ä¹Ÿæ²¡å…³ç³»ï¼Œä»ä¸Šé¢è‡³å°‘èƒ½çœ‹åˆ° _generated bytecode for function_ å‡ºç°äº†ä¸¤æ¬¡ï¼Œæ„å‘³ç€æœ‰ä¸¤ä¸ªå‡½æ•°ã€‚  
**æ³¨æ„ç‚¹2**é‚£é‡Œæœ‰ä¸€ä¸ª drink å…³é”®å­—ï¼Œä»£è¡¨æ˜¯æˆ‘ä»¬æ˜¾ç¤ºå£°æ˜çš„å‡½æ•°ï¼›**æ³¨æ„ç‚¹1**é‚£é‡Œå°±æ˜¯æ•´æ®µ js ä»£ç ï¼Œè¢«ä½œä¸ºäº†ä¸€ä¸ªåŒ¿åå‡½æ•°æ‰§è¡Œã€‚  
_æ³¨æ„ç‚¹3å°±æ˜¯è°ƒç”¨ drink çš„åœ°æ–¹ã€‚_

ä¸è¿‡ js æœ¬èº«æ˜¯ä¸€ä¸ªå‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œå‡½æ•°å¼æ˜¯å¦‚ä½•è¡¨ç°çš„æˆ‘ä»¬ä¸ç”¨å¤šè¯´ï¼Œé‡ç‚¹è¯´ä¸€è¯´ã€Œé—­åŒ…ã€ï¼Œé—­åŒ…ä¸€è¯ä¸å¯èƒ½æœ‰å‰ç«¯å¼€å‘ä¸çŸ¥é“(_å“ªæ€•æ²¡ç”¨è¿‡ï¼Œé¢è¯•ä¹Ÿé‡åˆ°è¿‡_)ï¼Œé‚£æˆ‘ä»¬æ€è€ƒä¸€ä¸‹ï¼Œä¸ºä»€ä¹ˆé—­åŒ…å¯ä»¥è·¨è¶Šæ ˆå¸§çš„é™åˆ¶ï¼Ÿ  
ä»¥ä¸‹é¢è¿™ä¸ªå‡½æ•°ä¸ºä¾‹:  
```
const drink = (function() {
    let flag = 0;
    return function() {
        if (++flag > 3) {
            console.log('åˆ©åˆ©å–ä¸åŠ¨äº†');
            return;
        }

        console.log('åˆ©åˆ©å¨å¨å¨');
    };
})();

drink();
```
å¦‚æœä½¿ç”¨ d8 è¾“å‡ºå­—èŠ‚ç ï¼Œå¯ä»¥çœ‹åˆ°æ€»å…±æœ‰ä¸‰ä¸ª generated bytecode for functionã€‚æ•´æ®µæ‰§è¡Œçš„è¿‡ç¨‹ï¼Œæˆ‘ä»¬å…ˆæŒ‰å¸¸ç†çŒœæµ‹ä¸€ä¸‹ï¼Œå‡½æ•°æ‰§è¡Œä½œç”¨åŸŸå˜åŒ–åº”è¯¥å¦‚ä¸‹:    
![](./assets/1.png)  
è¿™é‡Œæ€»å…±æœ‰ä¸‰ä¸ªé˜¶æ®µï¼Œé‡ç‚¹çœ‹åé¢ä¸¤ä¸ªã€‚  
- ç¬¬äºŒé˜¶æ®µæ˜¯æ‰§è¡Œäº†åŒ¿åçš„è‡ªæ‰§è¡Œå‡½æ•°ï¼Œæ­¤æ—¶å£°æ˜äº†ä¸€ä¸ª flag å˜é‡åœ¨å¯¹åº”çš„ä½œç”¨åŸŸã€‚
- ç¬¬ä¸‰é˜¶æ®µæ˜¯æ‰§è¡Œ drink å‡½æ•°ï¼Œè¿™é‡Œç”¨åˆ°äº†ä¸¤ä¸ªå˜é‡ã€‚  
1. consoleï¼Œæ¥è‡ªäºä¸Šå±‚çš„ä½œç”¨åŸŸï¼Œå¯ä»¥ç†è§£ã€‚
2. flagï¼Œè¿™ä¸ªå°±æ¯”è¾ƒè¯¡å¼‚äº†ï¼Œ**å› ä¸ºç†è®ºä¸Š flag åº”è¯¥éšç€åŒ¿åå‡½æ•°çš„æ‰§è¡Œç»“æŸé”€æ¯äº†æ‰å¯¹**ã€‚  

è¿™é‡Œ v8 åšäº†å¤„ç†ï¼Œå½“è§£æè„šæœ¬çš„æ—¶å€™ï¼Œå‘ç°è¿™æ ·çš„æƒ…å†µï¼Œä¼šåœ¨åŒ¿åå‡½æ•°æ‰§è¡Œé˜¶æ®µå°† flag æ‹·è´åˆ°å †ä¸­ï¼Œå¹¶ä¸”ç»™ drink å‡½æ•°å¢åŠ ä¸€ä¸ª scope å¼•ç”¨ã€‚  
æ‰€ä»¥çœŸå®çš„å›¾åº”è¯¥æ˜¯è¿™æ ·ï¼š  
![](./assets/2.png)  
ä»å­—èŠ‚ç ä¸Šæˆ‘ä»¬å¯ä»¥çœ‹åˆ°å½“ return çš„å‡½æ•°ä½¿æ²¡ä½¿ç”¨é—­åŒ…ï¼Œå­—èŠ‚ç æ˜¯æˆªç„¶ä¸åŒçš„ï¼Œå¦‚ä¸‹:  
```
// ä½¿ç”¨é—­åŒ…
const drink = (function() {
    let i = 0;
    return function() {
        if (++i > 3) {
            console.log('åˆ©åˆ©å–ä¸åŠ¨äº†');
            return;
        }
        console.log('åˆ©åˆ©å¨å¨å¨');
    };
})();

drink();
/////////////////////////////////
// åŒ¿åå‡½æ•°å­—èŠ‚ç å¦‚ä¸‹
[generated bytecode for function:  (0x3e97082125e9 <SharedFunctionInfo>)]
Parameter count 1
Register count 1
Frame size 8
         0x3e97082126d6 @    0 : 85 00 01          CreateFunctionContext [0], [1]
         0x3e97082126d9 @    3 : 16 fa             PushContext r0
         0x3e97082126db @    5 : 0f                LdaTheHole 
         0x3e97082126dc @    6 : 1d 02             StaCurrentContextSlot [2]
         0x3e97082126de @    8 : 0b                LdaZero 
         0x3e97082126df @    9 : 1d 02             StaCurrentContextSlot [2]
         0x3e97082126e1 @   11 : 82 01 00 02       CreateClosure [1], [0], #2
         0x3e97082126e5 @   15 : ab                Return 
Constant pool (size = 2)
Handler Table (size = 0)
Source Position Table (size = 0)
```
```
// æœªä½¿ç”¨é—­åŒ…
let i = 0;
const drink = (function() {
    return function() {
        if (++i > 3) {
            console.log('åˆ©åˆ©å–ä¸åŠ¨äº†');
            return;
        }
        console.log('åˆ©åˆ©å¨å¨å¨');
    };
})();

drink();
/////////////////////////////////
// åŒ¿åå‡½æ•°å­—èŠ‚ç å¦‚ä¸‹
[generated bytecode for function:  (0x11f5082125e9 <SharedFunctionInfo>)]
Parameter count 1
Register count 0
Frame size 0
         0x11f5082126d6 @    0 : 82 00 00 02       CreateClosure [0], [0], #2
         0x11f5082126da @    4 : ab                Return 
Constant pool (size = 1)
Handler Table (size = 0)
Source Position Table (size = 0)
```
ä½œç”¨åŸŸæŸ¥æ‰¾çš„ä»£ç åœ¨[https://github.com/v8/v8/blob/master/src/ast/scopes.cc#L1975](https://github.com/v8/v8/blob/master/src/ast/scopes.cc#L1975)ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚  

## C++ ä¸­çš„ callable
å¦‚æœæŸ¥çœ‹ v8 æºç çš„åŒå­¦ï¼Œæ·±å…¥åˆ°æ‰§è¡Œ Code å…·ä½“æ‰§è¡Œï¼Œå‘ç°æœ€åæ˜¯é€šè¿‡ Adress ç±»å‹ï¼Œè€Œ Adress å°±æ˜¯è¡¨ç¤ºäº†ä¸€ä¸ªåœ°å€ï¼Œä¸‹é¢æ˜¯ v8 çš„ Adress æºç :  
```
typedef uintptr_t Address;
```
é‚£ä¹ˆåœ°å€å¯ä»¥æ‰§è¡Œä¹ˆï¼Ÿå½“ç„¶å¯ä»¥ï¼Œçœ‹å¦‚ä¸‹ C++ ä»£ç :  
```
void drink() {
    printf("åˆ©åˆ©å¨å¨å¨ \n");
}

typedef unsigned long int uintptr_t;

int main(int argc, char* argv[]) {
    uintptr_t t = (uintptr_t)drink;
    ((void(*)(void))t)();
}
```
æˆ‘ä»¬æ²¡æœ‰é‡‡ç”¨æ˜¾å¼è°ƒç”¨çš„æ–¹å¼ï¼Œè€Œæ˜¯é‡‡å–äº†é€šè¿‡å‡½æ•°å…¥å£åœ°å€æ¥è°ƒç”¨ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹è¿™ç§æ–¹å¼å’Œç›´æ¥è°ƒç”¨æ±‡ç¼–ä¸Šçš„å·®å¼‚ã€‚  
![](./assets/3.png)  
å·¦è¾¹æ˜¯é€šè¿‡åœ°å€è°ƒç”¨ï¼Œå³è¾¹æ˜¯ç›´æ¥è°ƒç”¨ï¼Œå¯ä»¥çœ‹åˆ°æ±‡ç¼–å±‚é¢éƒ½æ˜¯ call å‘½ä»¤ï¼Œåªæ˜¯å‡½æ•°æŒ‡é’ˆæ˜¯æ‰‹åŠ¨è·å–åœ°å€å†èµ‹åˆ°äº†å¯„å­˜å™¨ä¸­æ‰§è¡Œè€Œå·²ã€‚  

è™½ç„¶ C++ ä¸æ˜¯å‡½æ•°å¼ç¼–ç¨‹è¯­è¨€ï¼Œæ— æ³•æ˜¾æ€§çš„ä¼ é€’å‡½æ•°ä½œä¸ºå‚æ•°ï¼Œä½†æ˜¯æˆ‘ä»¬çŸ¥é“äº†å‡½æ•°å…¶å®å°±æ˜¯ä¸€ä¸ªåœ°å€ï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨å‡½æ•°æŒ‡é’ˆè§£å†³ã€‚ç¤ºä¾‹ä»£ç å¾ˆç®€å•å°±ä¸è´´äº†ã€‚  

å¯¹äº C++ å±‚é¢çš„ callableï¼Œé‚£å¯å°±å¹¿æ³›äº†ï¼Œåªè¦æ˜¯é‡è½½äº† operator() çš„å¯¹è±¡ï¼Œéƒ½å¯ä»¥æˆä¸º callableï¼Œå¦‚ä¸‹:  
```
class Yori {
public:
    void operator()() const {
        printf("åˆ©åˆ©å¨å¨å¨ \n");
    }
};

int main() {
    Yori lili;
    lili();
}
```
æˆ‘ä»¬ä¸€èˆ¬ç§°ä¸ºè¿™ç§å¯¹è±¡ä¸º**å‡½æ•°å¯¹è±¡**ï¼Œè¿™ä¹Ÿæ˜¯ lambda è¡¨è¾¾å¼çš„åŸç†ï¼Œæ¯”å¦‚ä¸‹é¢ä¸¤ä¸ªæ‰§è¡Œæ–¹å¼ï¼ŒåŸç†æ˜¯ä¸€æ ·çš„ã€‚  
```
#define FUNC_BODY \
    if (curr++ >= limit) { \
        printf("åˆ©åˆ©å–ä¸åŠ¨äº† \n"); \
    } else { \
        printf("åˆ©åˆ©[%s]å¨å¨å¨ \n", type.c_str()); \
    } \

class Yori {
public:
    Yori() = delete;
    Yori(int& curr, int limit): curr(curr), limit(limit) {}

    void operator()(const string& type) { FUNC_BODY }
private:
    int& curr;
    int limit;
};

int main() {
    int curr = 0;
    int limit = 2;
    string type("ä¸€æ¯");

    // é€šè¿‡å‡½æ•°å¯¹è±¡çš„æ–¹å¼è¿›è¡Œ call
    Yori lili_class(curr, limit);
    lili_class(type);
    lili_class(type);
    lili_class(type);

    // é€šè¿‡ lambda çš„æ–¹å¼è¿›è¡Œ call
    auto lili_lambda = [&curr, limit](const string type)->void { FUNC_BODY };
    lili_lambda(type);
    lili_lambda(type);
    lili_lambda(type);
}
```
ä¸è¿‡è¿˜æ˜¯ lambda åœ¨å†™æ³•ä¸Šæ–¹ä¾¿äº†å¾ˆå¤šï¼Œè€Œä¸” lambda åœ¨**æ²¡æœ‰æ•è·åœºæ™¯**ä¸‹ï¼Œæ˜¯å¯ä»¥ä½œä¸ºå‡½æ•°æŒ‡é’ˆè¿›è¡Œè°ƒç”¨çš„ã€‚  
```
typedef void (*callback) ();

void drink(callback func) { // å‡½æ•°æŒ‡é’ˆä½œä¸ºå½¢å‚
    printf("åˆ©åˆ©å¨å¨å¨ \n");
    func(); // æ‰§è¡Œå‡½æ•°æŒ‡é’ˆ
}

int main() {
    drink([]() {}); // lambda è¡¨è¾¾å¼ä½œä¸ºå®å‚
    int i = 0;
    drink([&i]() {}); // å½“æœ‰æ•è·æ—¶ï¼ŒæŠ¥é”™! 
    return 0;
}
```
ç¬¬ä¸€ä¸ª drink å¯ä»¥æ­£å¸¸æŒ‡å®šï¼Œç¬¬äºŒä¸ªå°±ä¸è¡Œäº†ï¼Œå› ä¸ºæ‹¥æœ‰æ•è·çš„ lambda è¡¨è¾¾å¼æ˜¯æ— æ³•è½¬æ¢ä¸ºå‡½æ•°æŒ‡é’ˆçš„ã€‚  
> ä¸å­˜åœ¨ä» "lambda []void ()->void" åˆ° "callback" çš„é€‚å½“è½¬æ¢å‡½æ•°

å¯¹äºä¸Šé¢è¿™ç§æƒ…å†µï¼Œå¯ä»¥é‡‡ç”¨å‡½æ•°åŒ…è£…å™¨æ¨¡ç‰ˆï¼Œæˆ‘ä»¬åªéœ€è¦å°†ä¸Šé¢çš„ä»£ç æ”¹æˆè¿™æ ·å°±è¡Œ.  
```
void drink(function<void()> func) {
    printf("åˆ©åˆ©å¨å¨å¨ \n");
    func();
}

int main() {
    int i = 0;
    drink([&i]() {}); // æ•è·ä¹Ÿæ²¡äº‹äº†ï¼ŒğŸ›«ï¸
    return 0;
}
```
ä¹‹æ‰€ä»¥å¯ä»¥è¿™ä¹Ÿï¼Œæ˜¯å› ä¸º function åªå…³å¿ƒä½ æ˜¯ä¸æ˜¯ callable çš„ï¼Œå¹¶ä¸åœ¨ä¹ä½ æœ¬èº«æ˜¯å¦‚ä½• call çš„ã€‚  

## æ€»ç»“
ç®€å•åˆ†æäº†ä¸€ä¸‹ç¨‹åºä¸­çš„ callable å¯¹è±¡ï¼Œå¦‚æœæœ‰ä»€ä¹ˆé—®é¢˜ï¼Œå¯ä»¥ç•™è¨€è®¨è®ºï¼Œå¥¥åŠ›ç»™ã€‚  